# Пример расчета доставки по новой формуле

## Параметры системы (из config/deliveryConfig.ts)

```typescript
- Грузоподъемность машины: 2000 кг
- Объем кузова машины: 9 м³
- Средняя скорость: 20 км/ч
- Ставка: 850 руб/час
- Время погрузки/разгрузки: 0.5 ч
- Среднее расстояние: 7 км
- Мин. загрузка: 74.3%
- Доп. расходы: 100 руб
- Маржа: 10%
- Коэф. экспресс: 14.25%
```

## Пример запроса

```bash
curl -X POST http://localhost:3000/api/calculate \
  -H "Content-Type: application/json" \
  -H "x-api-key: your-api-key" \
  -H "Authorization: Basic $(echo -n 'username:password' | base64)" \
  -d '{
    "lat": 48.480223,
    "lon": 135.071917,
    "order": {
      "weight": 1500,
      "volume": 7,
      "cost": 50000
    }
  }'
```

## Расчет по формулам

### Входные данные:
- Вес: 1500 кг
- Объем: 7 м³

### Шаг 1: Реальная доля загрузки
```
Загрузка по весу = 1500 / 2000 = 0.75 (75%)
Загрузка по объему = 7 / 9 = 0.778 (77.8%)
Реальная доля загрузки = MAX(0.75, 0.778) = 0.778
```

### Шаг 2: Необходимое количество рейсов
```
Рейсы = ОКРУГЛВВЕРХ(0.778) = 1
```

### Шаг 3: Дополнительные рейсы
```
Доп. рейсы = 1 - 1 = 0
```

### Шаг 4: Реальная доля загрузки с учетом минимума
```
Так как рейсов <= 1:
Загрузка с мин = MAX(0.743, 0.778) = 0.778
```

### Шаг 5: Время работ (погрузка/разгрузка)
```
Время работ = 0.778 * 0.5 = 0.389 часа
```

### Шаг 6: Среднее время доставки
```
Время доставки = 7 / 20 = 0.35 часа
```

### Шаг 7: Время доставки с учетом загрузки
```
Время с загрузкой = 0.35 * 0.778 = 0.272 часа
```

### Шаг 8: Себестоимость
```
Себестоимость = ((0.272 + 0.389) * 850) + 100 = 661.85 + 100 = 761.85 руб
```

### Шаг 9: Стоимость для клиента
```
Стоимость = ОКРУГЛВНИЗ(761.85 * 1.10) = ОКРУГЛВНИЗ(838.04) = 838 руб
```

### Шаг 10-11: Экспресс доставка
```
Экспресс себестоимость = 761.85 * 1.1425 = 870.41 руб
Экспресс для клиента = ОКРУГЛВНИЗ(870.41 * 1.10) = ОКРУГЛВНИЗ(957.45) = 957 руб
```

## Ожидаемый ответ

```json
{
  "delivery_cost": 838,
  "delivery_time": "1-2 дня",
  "express_delivery_cost": 957,
  "options": [
    {
      "name": "Экспресс доставка",
      "cost": 957,
      "description": "Приоритетная доставка"
    }
  ],
  "zoneInfo": {
    "inZone": true,
    "zoneName": "Зона доставки — Хабаровск"
  }
}
```

## Изменение параметров

Все параметры расчета можно легко изменить в файле `src/config/deliveryConfig.ts`:

```typescript
// Например, изменить ставку:
HOURLY_RATE: 950, // было 850

// Или изменить минимальную загрузку:
MIN_CITY_LOAD_PERCENTAGE: 80, // было 74.3
```
