stages:
  - deploy

deploy:
  stage: deploy
  script:
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSH-–∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    - 'which ssh-agent || ( apt-get update -qq && apt-get install -y openssh-client git )'

    # –û—Ç–ª–∞–¥–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    - echo "üîç DEBUG - SERVER_IP='$SERVER_IP'"
    - echo "üîç DEBUG - SSH_PRIVATE length=${#SSH_PRIVATE}"
    
    # –í—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º IP –¥–ª—è —Ç–µ—Å—Ç–∞ (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® IP!)
    - export TEST_SERVER_IP="89.169.3.229"
    - echo "üîç Using test IP=$TEST_SERVER_IP"

    # –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞
    - eval $(ssh-agent -s)

    # –°–æ–∑–¥–∞–Ω–∏—è .ssh directory
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π GitLab
    - echo "$SSH_PRIVATE" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519

    # –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Å—Ç –≤ known_hosts (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π IP)
    - mkdir -p ~/.ssh
    - ssh-keyscan -H $TEST_SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

    # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π IP)
    - ssh -v -o StrictHostKeyChecking=yes admin@$TEST_SERVER_IP "
        cd /opt/delivery-uroven &&
        echo 'üîÅ –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è...' &&
        git pull origin main &&
        echo 'üõ†Ô∏è –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã...' &&
        docker compose build --no-cache &&
        echo 'üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...' &&
         docker compose down &&
        echo 'üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã...' &&
        docker compose up -d
      "
  only:
    - main
