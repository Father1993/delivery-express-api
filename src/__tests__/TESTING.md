# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é API —Å–µ—Ä–≤–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
npm test

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
npm run test:watch

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –æ—Ç—á–µ—Ç–æ–º –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
w

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º Supabase
RUN_INTEGRATION_TESTS=true npm test
```

## üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env.test`

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env.test` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# –¢–µ—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
NODE_ENV=test
LOG_LEVEL=ERROR
LOG_TO_CONSOLE=false

# –¢–µ—Å—Ç–æ–≤—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è Basic Auth
API_USERNAME=–≤–∞—à_—Ç–µ—Å—Ç–æ–≤—ã–π_–ª–æ–≥–∏–Ω
API_PASSWORD=–≤–∞—à_—Ç–µ—Å—Ç–æ–≤—ã–π_–ø–∞—Ä–æ–ª—å

# –¢–µ—Å—Ç–æ–≤—ã–π API –∫–ª—é—á
API_KEY_CS_CART=–≤–∞—à_—Ç–µ—Å—Ç–æ–≤—ã–π_api_–∫–ª—é—á

# –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è Supabase
SUPABASE_URL=https://supabase.uroven.pro
SUPABASE_ANON_KEY=–≤–∞—à_—Ç–µ—Å—Ç–æ–≤—ã–π_–∫–ª—é—á_supabase
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `.env.test` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`!

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
src/__tests__/
‚îú‚îÄ‚îÄ setup.ts                    # üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ helpers.ts                   # üõ†Ô∏è –û–±—â–∏–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤
‚îú‚îÄ‚îÄ app.ts                      # üåê –¢–µ—Å—Ç–æ–≤–æ–µ Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ unit/                       # üß™ –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Ç–µ—Å—Ç–∏—Ä—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
‚îÇ   ‚îú‚îÄ‚îÄ middleware.test.ts      # –¢–µ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ services.test.ts        # –¢–µ—Å—Ç—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
‚îú‚îÄ‚îÄ api/                        # üåê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Ç–µ—Å—Ç–∏—Ä—É—é—Ç API)
‚îÇ   ‚îú‚îÄ‚îÄ calculation.test.ts     # –¢–µ—Å—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ zone.test.ts           # –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–æ–Ω
‚îú‚îÄ‚îÄ integration/                # üöÄ E2E —Ç–µ—Å—Ç—ã (—Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
‚îÇ   ‚îî‚îÄ‚îÄ supabase.integration.test.ts
‚îî‚îÄ‚îÄ mocks/                      # üé≠ –ü–æ–¥–¥–µ–ª–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
    ‚îî‚îÄ‚îÄ services.ts
```

## üéØ –¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤

### 1. **–ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã** (`unit/`)
- –¢–µ—Å—Ç–∏—Ä—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç –º–æ–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ë—ã—Å—Ç—Ä—ã–µ –∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ

### 2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** (`api/`)
- –¢–µ—Å—Ç–∏—Ä—É—é—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å API –∑–∞–ø—Ä–æ—Å–∞
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –≤–∞–ª–∏–¥–∞—Ü–∏—é, –æ–±—Ä–∞–±–æ—Ç–∫—É
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç –º–æ–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### 3. **E2E —Ç–µ—Å—Ç—ã** (`integration/`)
- –¢–µ—Å—Ç–∏—Ä—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º
- –ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å —Ñ–ª–∞–≥–æ–º `RUN_INTEGRATION_TESTS=true`

## üõ†Ô∏è –û–±—â–∏–µ —Ö–µ–ª–ø–µ—Ä—ã

### `makeAuthRequest(app, endpoint)`
–°–æ–∑–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å –¥–ª—è API —Ç–µ—Å—Ç–æ–≤:

```typescript
import { makeAuthRequest } from '../helpers'

const response = await makeAuthRequest(app, 'calculate').send({
    coordinates: TEST_COORDINATES.IN_ZONE,
    order: { weight: 5, cost: 1000 }
})
```

### `TEST_COORDINATES`
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:

```typescript
import { TEST_COORDINATES } from '../helpers'

// –í –∑–æ–Ω–µ –¥–æ—Å—Ç–∞–≤–∫–∏ (–•–∞–±–∞—Ä–æ–≤—Å–∫)
TEST_COORDINATES.IN_ZONE    // { lat: 48.5, lon: 135.1 }

// –í–Ω–µ –∑–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏ (–ú–æ—Å–∫–≤–∞)  
TEST_COORDINATES.OUT_OF_ZONE // { lat: 55.7558, lon: 37.6173 }
```

## üé≠ –ú–æ–∫–∏ –∏ –ø–æ–¥–¥–µ–ª–∫–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–∫–æ–≤
–í—Å–µ –º–æ–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ `setup.ts`:
- **Supabase** - –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –∑–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏
- **–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤

### –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–æ–∫–æ–≤
–ú–æ–∫–∏ –≤ `services.ts` –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –≤ `setup.ts`:
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –•–∞–±–∞—Ä–æ–≤—Å–∫–µ ‚Üí –≤ –∑–æ–Ω–µ –¥–æ—Å—Ç–∞–≤–∫–∏
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω–µ –•–∞–±–∞—Ä–æ–≤—Å–∫–∞ ‚Üí –≤–Ω–µ –∑–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏

## üìä –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

–¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: **79%** (–æ—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!)

```bash
npm run test:coverage
```

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **setup.ts** –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ
2. **–ú–æ–∫–∏** –∑–∞–º–µ–Ω—è—é—Ç –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ –ø–æ–¥–¥–µ–ª–∫–∏
3. **Unit —Ç–µ—Å—Ç—ã** –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
4. **API —Ç–µ—Å—Ç—ã** –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ø–æ–ª–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã
5. **E2E —Ç–µ—Å—Ç—ã** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

---

## üÜï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### 1. **–ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å**
```typescript
// 1. –°–æ–∑–¥–∞–π—Ç–µ —Å–µ—Ä–≤–∏—Å –≤ src/services/newService.ts
// 2. –î–æ–±–∞–≤—å—Ç–µ –º–æ–∫ –≤ src/__tests__/mocks/services.ts
export const mockNewService = jest.fn().mockImplementation(...)

// 3. –°–æ–∑–¥–∞–π—Ç–µ unit —Ç–µ—Å—Ç –≤ src/__tests__/unit/newService.test.ts
import '../setup'
import '../mocks/services'

describe('–ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å', () => {
    test('—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é', () => {
        // —Ç–µ—Å—Ç
    })
})
```

### 2. **–ù–æ–≤—ã–π API —ç–Ω–¥–ø–æ–∏–Ω—Ç**
```typescript
// 1. –°–æ–∑–¥–∞–π—Ç–µ —Ä–æ—É—Ç –≤ src/routes/newRoute.ts
// 2. –î–æ–±–∞–≤—å—Ç–µ –≤ src/__tests__/app.ts
apiRouter.use('/new', newRoutes)

// 3. –°–æ–∑–¥–∞–π—Ç–µ API —Ç–µ—Å—Ç –≤ src/__tests__/api/newRoute.test.ts
import { makeAuthRequest, TEST_COORDINATES } from '../helpers'

describe('API –Ω–æ–≤–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞', () => {
    test('—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç', async () => {
        const response = await makeAuthRequest(app, 'new').send({
            // –¥–∞–Ω–Ω—ã–µ
        })
        expect(response.status).toBe(200)
    })
})
```

### 3. **–ù–æ–≤—ã–π middleware**
```typescript
// 1. –°–æ–∑–¥–∞–π—Ç–µ middleware –≤ src/middleware/newMiddleware.ts
// 2. –°–æ–∑–¥–∞–π—Ç–µ unit —Ç–µ—Å—Ç –≤ src/__tests__/unit/newMiddleware.test.ts
import '../setup'

describe('–ù–æ–≤—ã–π middleware', () => {
    test('—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç middleware', () => {
        // —Ç–µ—Å—Ç
    })
})
```

### 4. **–ù–æ–≤—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ**
```typescript
// –î–æ–±–∞–≤—å—Ç–µ –≤ src/__tests__/helpers.ts
export const NEW_TEST_DATA = {
    // –Ω–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
}
```

## üìù –ü–∞–º—è—Ç–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º

### ‚úÖ **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞–π—Ç–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `makeAuthRequest()` –¥–ª—è API —Ç–µ—Å—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `TEST_COORDINATES` –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- –î–æ–±–∞–≤–ª—è–π—Ç–µ –º–æ–∫–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ, –∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –û–±–Ω–æ–≤–ª—è–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ API

### ‚ùå **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–π—Ç–µ:**
- –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–¥–µ —Ç–µ—Å—Ç–æ–≤
- –ù–µ –¥–µ–ª–∞–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ unit/API —Ç–µ—Å—Ç–∞—Ö
- –ù–µ –¥—É–±–ª–∏—Ä—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
- –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### üéØ **–ü—Ä–∏–Ω—Ü–∏–ø—ã —Ö–æ—Ä–æ—à–∏—Ö —Ç–µ—Å—Ç–æ–≤:**
- **–ë—ã—Å—Ç—Ä—ã–µ** - unit —Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- **–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ** - –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∞–º –ø–æ —Å–µ–±–µ
- **–ü–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ** - –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
- **–ü–æ–Ω—è—Ç–Ω—ã–µ** - —è—Å–Ω–æ —á—Ç–æ –∏ –∑–∞—á–µ–º —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è

### üöÄ **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**
```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤
npm run test:watch

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ unit —Ç–µ—Å—Ç–æ–≤
npm test -- unit/

# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ API —Ç–µ—Å—Ç–æ–≤  
npm test -- api/

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
npm run test:coverage
```

---

**–ü–æ–º–Ω–∏—Ç–µ: —Ö–æ—Ä–æ—à–∏–µ —Ç–µ—Å—Ç—ã = –Ω–∞–¥–µ–∂–Ω—ã–π –∫–æ–¥!** üéâ