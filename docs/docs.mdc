–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–µ—Ä–≤–∏—Å –ø–æ—Å—Ç—Ä–æ–µ–Ω –ø–æ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:

```
src/
‚îú‚îÄ‚îÄ index.ts              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ middleware/           # Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ models/              # TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ç–∏–ø—ã
‚îú‚îÄ‚îÄ routes/              # API –º–∞—Ä—à—Ä—É—Ç—ã
‚îú‚îÄ‚îÄ services/            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îî‚îÄ‚îÄ utils/               # –£—Ç–∏–ª–∏—Ç—ã (–ª–æ–≥–≥–µ—Ä)
```

## üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 1. **`index.ts` - –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

```typescript
// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Express —Å–µ—Ä–≤–µ—Ä–∞
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware (CORS, JSON –ø–∞—Ä—Å–∏–Ω–≥)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è API –º–∞—Ä—à—Ä—É—Ç–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 3000
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- CORS –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –î–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö API endpoint: `/api/calculate` –∏ `/api/zone`

### 2. **`middleware/auth.ts` - –°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**

```typescript
// –¢—Ä–∏ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã:
1. validateApiKey() - –ø—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ x-api-key
2. basicAuth() - Basic Authentication (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å)
3. apiProtection - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π middleware [basicAuth, validateApiKey]
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
- –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è Basic Auth (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è API –∫–ª—é—á
- –û–±–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: `API_USERNAME`, `API_PASSWORD`, `API_KEY_CS_CART`

### 3. **`models/deliveryData.ts` - –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö**

```typescript
// –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:
- Coordinates: { lat: number, lon: number }
- OrderInfo: { weight: number, cost: number, items?: number }
- DeliveryCalculationRequest: { lat, lon, order, zoneInfo? }
- ZoneInfo: { inZone: boolean, zoneName?, error? }
- DeliveryCalculationResponse: { delivery_cost, delivery_time, options?, zoneInfo? }
- DeliveryZoneData: –¥–∞–Ω–Ω—ã–µ –∑–æ–Ω—ã –∏–∑ Supabase
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í—Å–µ –ø–æ–ª—è —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤

### 4. **`routes/calculation.ts` - API —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏**

**Endpoint:** `POST /api/calculate`

**–í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞:**
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π:
- lat, lon (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
- order (–≤–µ—Å –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å)
- zoneInfo (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–æ–Ω–µ)

// –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è:
- lat: -90 –¥–æ 90
- lon: -180 –¥–æ 180  
- weight: > 0
- cost: >= 0
- zoneInfo.inZone: true
```

**–õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ `req.body`
2. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
3. –í—ã–∑–æ–≤ `calculateDelivery()` –∏–∑ —Å–µ—Ä–≤–∏—Å–∞
4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ `zoneInfo` –≤ –æ—Ç–≤–µ—Ç
5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
6. –í–æ–∑–≤—Ä–∞—Ç JSON –æ—Ç–≤–µ—Ç–∞

### 5. **`routes/zone.ts` - API –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–æ–Ω**

**Endpoint:** `POST /api/zone`

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:
- lat: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º
- lon: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º
```

**–õ–æ–≥–∏–∫–∞:**
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `lat, lon` –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
2. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
3. –í—ã–∑–æ–≤ `checkDeliveryZone()` –∏–∑ —Å–µ—Ä–≤–∏—Å–∞
4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ timestamp –≤ –æ—Ç–≤–µ—Ç
5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### 6. **`services/calculationService.ts` - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞**

**–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏:**

```typescript
// –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
BASE_DELIVERY_COST = 150 —Ä—É–±.    // –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
COST_PER_KM = 10 —Ä—É–±.           // –ó–∞ –∫–∏–ª–æ–º–µ—Ç—Ä
WEIGHT_MULTIPLIER = 5 —Ä—É–±.      // –ó–∞ –∫–≥ –≤–µ—Å–∞

// –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞:
deliveryCost = BASE_DELIVERY_COST + distance * COST_PER_KM + weight * WEIGHT_MULTIPLIER

// –°–∫–∏–¥–∫–∏:
- –ï—Å–ª–∏ order.cost > 5000: —Å–∫–∏–¥–∫–∞ 10% –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É

// –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏:
- < 10 –∫–º: "1-2 –¥–Ω—è"
- 10-30 –∫–º: "2-3 –¥–Ω—è"  
- > 30 –∫–º: "3-5 –¥–Ω–µ–π"

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏:
- –ï—Å–ª–∏ < 20 –∫–º: –¥–æ—Å—Ç—É–ø–Ω–∞ "–≠–∫—Å–ø—Ä–µ—Å—Å –¥–æ—Å—Ç–∞–≤–∫–∞" (+50% –∫ —Å—Ç–æ–∏–º–æ—Å—Ç–∏)
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
- –ë–∞–∑–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –•–∞–±–∞—Ä–æ–≤—Å–∫ (48.480223, 135.071917)
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ —Ä–∞—Å—á–µ—Ç–∞

### 7. **`services/zoneService.ts` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Supabase**

**–§—É–Ω–∫—Ü–∏—è:** `checkDeliveryZone(coordinates: Coordinates)`

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —á–µ—Ä–µ–∑ RPC —Ñ—É–Ω–∫—Ü–∏—é `is_in_delivery_zone`
2. –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
3. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∑–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏
4. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
   - –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ = –≤–Ω–µ –∑–æ–Ω—ã
   - –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ = –≤ –∑–æ–Ω–µ (–±–µ—Ä–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è –∑–æ–Ω–∞)

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- –û—à–∏–±–∫–∏ Supabase –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –¥–µ—Ç–∞–ª—è–º–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- Graceful fallback –ø—Ä–∏ —Å–±–æ—è—Ö

### 8. **`utils/logger.ts` - –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
```typescript
// –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
ERROR, WARN, INFO, DEBUG

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
LOG_DIR, LOG_FILE, LOG_TO_CONSOLE, LOG_LEVEL

// –§—É–Ω–∫—Ü–∏–∏:
- –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª (logs/app.log)
- –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å —Å —Ü–≤–µ—Ç–∞–º–∏
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å timestamp
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—é
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤
- –¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

## üîÑ –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### –ó–∞–ø—Ä–æ—Å —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:

```
1. HTTP POST /api/calculate
2. Middleware: basicAuth + validateApiKey
3. –í–∞–ª–∏–¥–∞—Ü–∏—è: lat, lon, order, zoneInfo
4. –°–µ—Ä–≤–∏—Å: calculateDelivery()
   - –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ —Å–∫–∏–¥–æ–∫
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ zoneInfo –≤ –æ—Ç–≤–µ—Ç
6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
7. –í–æ–∑–≤—Ä–∞—Ç JSON –æ—Ç–≤–µ—Ç–∞
```

### –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–æ–Ω—ã:

```
1. HTTP POST /api/zone  
2. Middleware: basicAuth + validateApiKey
3. –í–∞–ª–∏–¥–∞—Ü–∏—è: lat, lon (—á–∏—Å–ª–∞)
4. –°–µ—Ä–≤–∏—Å: checkDeliveryZone()
   - RPC –∑–∞–ø—Ä–æ—Å –∫ Supabase
   - –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ timestamp
6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
7. –í–æ–∑–≤—Ä–∞—Ç JSON –æ—Ç–≤–µ—Ç–∞
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** Basic Auth + API Key
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:** –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **CORS:** –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## ÔøΩÔøΩ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- **HTTP –∑–∞–ø—Ä–æ—Å—ã:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:** –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤
- **–û—à–∏–±–∫–∏:** –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å stack trace
- **–§–∞–π–ª—ã –ª–æ–≥–æ–≤:** `logs/app.log` —Å —Ä–æ—Ç–∞—Ü–∏–µ–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- **Unit —Ç–µ—Å—Ç—ã:** –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ middleware
- **API —Ç–µ—Å—Ç—ã:** –¥–ª—è endpoints
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:** –¥–ª—è Supabase (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **–ú–æ–∫–∏:** –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤

–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π API –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

```plaintext
src/
‚îú‚îÄ‚îÄ index.ts              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ middleware/           # Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ models/              # TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ç–∏–ø—ã
‚îú‚îÄ‚îÄ routes/              # API –º–∞—Ä—à—Ä—É—Ç—ã
‚îú‚îÄ‚îÄ services/            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îî‚îÄ‚îÄ utils/               # –£—Ç–∏–ª–∏—Ç—ã (–ª–æ–≥–≥–µ—Ä)
```

```typescript
// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Express —Å–µ—Ä–≤–µ—Ä–∞
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware (CORS, JSON –ø–∞—Ä—Å–∏–Ω–≥)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è API –º–∞—Ä—à—Ä—É—Ç–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 3000
```

```typescript
// –¢—Ä–∏ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã:
1. validateApiKey() - –ø—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ x-api-key
2. basicAuth() - Basic Authentication (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å)
3. apiProtection - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π middleware [basicAuth, validateApiKey]
```

```typescript
// –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:
- Coordinates: { lat: number, lon: number }
- OrderInfo: { weight: number, cost: number, items?: number }
- DeliveryCalculationRequest: { lat, lon, order, zoneInfo? }
- ZoneInfo: { inZone: boolean, zoneName?, error? }
- DeliveryCalculationResponse: { delivery_cost, delivery_time, options?, zoneInfo? }
- DeliveryZoneData: –¥–∞–Ω–Ω—ã–µ –∑–æ–Ω—ã –∏–∑ Supabase
```

```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π:
- lat, lon (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
- order (–≤–µ—Å –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å)
- zoneInfo (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–æ–Ω–µ)

// –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è:
- lat: -90 –¥–æ 90
- lon: -180 –¥–æ 180  
- weight: > 0
- cost: >= 0
- zoneInfo.inZone: true
```

```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:
- lat: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º
- lon: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º
```

```typescript
// –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
BASE_DELIVERY_COST = 150 —Ä—É–±.    // –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
COST_PER_KM = 10 —Ä—É–±.           // –ó–∞ –∫–∏–ª–æ–º–µ—Ç—Ä
WEIGHT_MULTIPLIER = 5 —Ä—É–±.      // –ó–∞ –∫–≥ –≤–µ—Å–∞

// –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞:
deliveryCost = BASE_DELIVERY_COST + distance * COST_PER_KM + weight * WEIGHT_MULTIPLIER

// –°–∫–∏–¥–∫–∏:
- –ï—Å–ª–∏ order.cost > 5000: —Å–∫–∏–¥–∫–∞ 10% –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É

// –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏:
- < 10 –∫–º: "1-2 –¥–Ω—è"
- 10-30 –∫–º: "2-3 –¥–Ω—è"  
- > 30 –∫–º: "3-5 –¥–Ω–µ–π"

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏:
- –ï—Å–ª–∏ < 20 –∫–º: –¥–æ—Å—Ç—É–ø–Ω–∞ "–≠–∫—Å–ø—Ä–µ—Å—Å –¥–æ—Å—Ç–∞–≤–∫–∞" (+50% –∫ —Å—Ç–æ–∏–º–æ—Å—Ç–∏)
```

```typescript
// –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
ERROR, WARN, INFO, DEBUG

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
LOG_DIR, LOG_FILE, LOG_TO_CONSOLE, LOG_LEVEL

// –§—É–Ω–∫—Ü–∏–∏:
- –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª (logs/app.log)
- –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å —Å —Ü–≤–µ—Ç–∞–º–∏
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å timestamp
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É—Ä–æ–≤–Ω—é
```

```plaintext
1. HTTP POST /api/calculate
2. Middleware: basicAuth + validateApiKey
3. –í–∞–ª–∏–¥–∞—Ü–∏—è: lat, lon, order, zoneInfo
4. –°–µ—Ä–≤–∏—Å: calculateDelivery()
   - –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏ —Å–∫–∏–¥–æ–∫
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ zoneInfo –≤ –æ—Ç–≤–µ—Ç
6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
7. –í–æ–∑–≤—Ä–∞—Ç JSON –æ—Ç–≤–µ—Ç–∞
```

```plaintext
1. HTTP POST /api/zone  
2. Middleware: basicAuth + validateApiKey
3. –í–∞–ª–∏–¥–∞—Ü–∏—è: lat, lon (—á–∏—Å–ª–∞)
4. –°–µ—Ä–≤–∏—Å: checkDeliveryZone()
   - RPC –∑–∞–ø—Ä–æ—Å –∫ Supabase
   - –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ timestamp
6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
7. –í–æ–∑–≤—Ä–∞—Ç JSON –æ—Ç–≤–µ—Ç–∞
```

